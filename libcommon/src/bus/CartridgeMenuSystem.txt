
# **VCC Cartridge Export Based Menu System**

This replaces per‑item callbacks with a single export‑based model for exchanging menu
items between cartridge DLLs, Multipak (MPI), and the PakInterface host.

Concept:

- Each cartridge DLL maintains its own internal list of menu items.  
- Each DLL exposes **one export** that returns its entire menu list on demand.  
- MPI aggregates child cartridge menus, applies slot‑based ID biasing, and returns a
  unified list to the host.  
- The host rebuilds the UI menu from the aggregated list.  
- DLLs notify the host of menu changes using a single Windows message.

Benefits:

- Menu state is always derived from a **single export call**, not a sequence of callbacks.  
- DLLs do not depend on host internals, callback tables, or routing logic.  
- Clear separation of responsibilities:
  - DLLs own their menu state.  
  - MPI aggregates and biases.  
  - Host renders.  
- The export signature and struct layout remain stable even if internal implementations change.

---

## **Component Details**

### **Cartridge DLL**

A cartridge DLL:

- Maintains a **static internal list** of its menu items.  
- Updates this list whenever its internal state changes.  
- Sends **WM_VCC_MENU_CHANGED** to the host after updating its list.  
- Implements a single GetMenuItemList export that:
  - Accepts a pointer to a buffer of menu items (or `nullptr` for size query).  
  - Accepts a pointer to a count value.  
  - Interprets the count as:
    - **Input:** maximum number of items the host can accept.  
    - **Output:** total number of items the DLL has (or number copied).  
- Never copies more items than the host indicates.  
- Returns failure if not all items could be copied.
- Protects the list from export access while it is being updated.

If the buffer pointer is `nullptr`, the DLL sets count to the number of items it has.
If the buffer pointer is not `nullptr`, the DLL copies up to the specified count.

---

### **Multipak (MPI)**

MPI acts as an **aggregator** and applies deterministic slot‑based menu ID biasing.
The MPI is only permitted to be installed in the boot slot. (Coco side slot)

MPI:

- Maintains references to each child cartridge’s menu export.  
- When its export is called:
  - Generates MPI’s own menu items.  
  - Calls each child cartridge’s export to retrieve their items.  
  - Applies **slot‑based menu ID biasing**:
    - Each slot receives a unique bias range.  
    - Biasing is applied only by MPI.  
    - DLLs remain unaware of slot numbers or bias rules.  
  - Merges all items into a single unified list.  
- Returns the unified list to the host using the same export pattern as cartridges.

---

### **PakInterface Host**

The host:

- Listens for **WM_VCC_MENU_CHANGED** from any DLL including the MPI.  
- On receiving the message, calls the boot slot's export and rebuilds the menu.

The host only sees a flat, final list of menu items.

